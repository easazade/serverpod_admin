<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{class}} - Bulk Insert - Serverpod Admin</title>
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        /* Bulk insert specific styles */
        .bulk-container {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }

        .bulk-header {
            background: #f8f9fa;
            padding: 16px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bulk-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .bulk-content {
            padding: 20px;
        }

        .json-input-container {
            margin-bottom: 20px;
        }

        .json-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            display: block;
        }

        .json-textarea {
            width: 100%;
            min-height: 400px;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
            resize: vertical;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .json-textarea:focus {
            outline: 0;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .json-textarea.valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .json-textarea.invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .validation-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }

        .validation-status.valid {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .validation-status.invalid {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .validation-status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            line-height: 1.4;
        }

        .example-json {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #495057;
            white-space: pre-wrap;
        }

        .form-actions {
            background: #f8f9fa;
            padding: 16px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-actions-left {
            display: flex;
            gap: 10px;
        }

        .form-actions-right {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: background-color 0.15s ease-in-out;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sidebar {
            width: 300px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section h3 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }

        .sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <img src="/images/serverpod-admin-logo.png" width="200" style="margin-top: 8px; margin-bottom: 12px;">
            <div class="header-links">
                <a href="/" class="header-link">VIEW SITE</a>
                <a href="/admin/password_change/" class="header-link">CHANGE PASSWORD</a>
                <a href="/admin/logout/" class="header-link">LOG OUT</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <div class="content-area">
            <!-- Breadcrumb -->
            <div style="margin-bottom: 20px;">
                <a href="/admin/" style="color: #007bff; text-decoration: none;">← Back to Admin</a>
                <span style="color: #6c757d; margin: 0 8px;">/</span>
                <a href="{{table_url}}" style="color: #007bff; text-decoration: none;">{{class}}</a>
                <span style="color: #6c757d; margin: 0 8px;">/</span>
                <span style="color: #6c757d;">Bulk Insert</span>
            </div>

            <!-- Bulk Insert Container -->
            <div class="bulk-container">
                <!-- Bulk Header -->
                <div class="bulk-header">
                    <h1 class="bulk-title">Bulk Insert {{class}} Objects</h1>
                </div>

                <!-- Bulk Content -->
                <form id="bulkInsertForm" method="POST" action="{{bulk_save_url}}">
                    <div class="bulk-content">
                        <!-- Stats Container -->
                        <div class="stats-container">
                            <div class="stat-item">
                                <span class="stat-number" id="objectCount">0</span>
                                <span class="stat-label">Objects</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="validCount">0</span>
                                <span class="stat-label">Valid</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="invalidCount">0</span>
                                <span class="stat-label">Invalid</span>
                            </div>
                        </div>

                        <!-- JSON Input Container -->
                        <div class="json-input-container">
                            <label class="json-label" for="jsonData">
                                JSON Array of {{class}} Objects
                            </label>
                            <textarea 
                                id="jsonData" 
                                name="jsonData" 
                                class="json-textarea" 
                                placeholder="Enter a JSON array of {{class}} objects here...
Example:
[
  {
    &quot;field1&quot;: &quot;value1&quot;,
    &quot;field2&quot;: 123,
    &quot;field3&quot;: true
  },
  {
    &quot;field1&quot;: &quot;value2&quot;,
    &quot;field2&quot;: 456,
    &quot;field3&quot;: false
  }
]"
                                required></textarea>
                            
                            <!-- Validation Status -->
                            <div id="validationStatus" class="validation-status"></div>

                            <!-- Example JSON -->
                            <div class="example-json" id="exampleJson" style="display: none;">
                                <strong>Example JSON structure:</strong>
[
  {
    "field1": "value1",
    "field2": 123,
    "field3": true
  },
  {
    "field1": "value2", 
    "field2": 456,
    "field3": false
  }
]
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div class="form-actions-left">
                            <a href="{{table_url}}" class="btn btn-secondary">Cancel</a>
                            <button type="button" class="btn btn-primary" onclick="toggleExample()">Show/Hide Example</button>
                            <button type="button" class="btn btn-primary" onclick="formatJson()">Format JSON</button>
                        </div>
                        <div class="form-actions-right">
                            <button type="submit" id="insertButton" class="btn btn-success" disabled>
                                Insert Bulk
                                <div class="loading-spinner" id="loadingSpinner"></div>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>Actions</h3>
                <div class="sidebar-actions">
                    <a class="sidebar-btn btn btn-secondary" href="{{table_url}}">Cancel</a>
                    <button class="sidebar-btn btn btn-success" form="bulkInsertForm" type="submit" id="sidebarInsertButton" disabled>
                        Insert Bulk
                    </button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Bulk Insert Help</h3>
                <p style="font-size: 12px; color: #6c757d; line-height: 1.4;">
                    <strong>JSON Format:</strong><br>
                    • Must be a valid JSON array<br>
                    • Each array item should be a {{class}} object<br>
                    • All required fields must be present<br>
                    • Field types must match the expected format
                </p>
            </div>

            <div class="sidebar-section">
                <h3>Validation</h3>
                <p style="font-size: 12px; color: #6c757d; line-height: 1.4;">
                    The form validates JSON in real-time and shows:<br>
                    • Total number of objects<br>
                    • Valid object count<br>
                    • Invalid object count<br>
                    • Specific validation errors
                </p>
            </div>

            <div class="sidebar-section">
                <h3>Notes</h3>
                <p style="font-size: 12px; color: #6c757d; line-height: 1.4;">
                    • If an object with the same id already exists serverpod admin will update existing object
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const jsonTextarea = document.getElementById('jsonData');
            const validationStatus = document.getElementById('validationStatus');
            const insertButton = document.getElementById('insertButton');
            const sidebarInsertButton = document.getElementById('sidebarInsertButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const form = document.getElementById('bulkInsertForm');

            // Real-time JSON validation
            jsonTextarea.addEventListener('input', function() {
                validateJson();
            });

            // Form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!isJsonValid) {
                    alert('Please fix JSON validation errors before submitting.');
                    return;
                }

                // Show loading state
                insertButton.disabled = true;
                sidebarInsertButton.disabled = true;
                loadingSpinner.style.display = 'inline-block';
                insertButton.textContent = 'Inserting...';
                sidebarInsertButton.textContent = 'Inserting...';

                try {
                    const jsonData = jsonTextarea.value.trim();
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: jsonData,
                        redirect: 'follow'
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }

                    // Get the response HTML and replace the current page
                    const html = await response.text();
                    document.open();
                    document.write(html);
                    document.close();
                } catch (error) {
                    console.error('Bulk insert failed:', error);
                    alert('Bulk insert failed: ' + error.message);
                    
                    // Reset loading state
                    insertButton.disabled = false;
                    sidebarInsertButton.disabled = false;
                    loadingSpinner.style.display = 'none';
                    insertButton.textContent = 'Insert Bulk';
                    sidebarInsertButton.textContent = 'Insert Bulk';
                }
            });

            let isJsonValid = false;

            function validateJson() {
                const jsonText = jsonTextarea.value.trim();
                
                if (!jsonText) {
                    showValidationStatus('info', 'Enter JSON data to begin validation');
                    updateStats(0, 0, 0);
                    setValidState(false);
                    return;
                }

                try {
                    const parsed = JSON.parse(jsonText);
                    
                    if (!Array.isArray(parsed)) {
                        showValidationStatus('invalid', 'JSON must be an array of objects');
                        updateStats(0, 0, 1);
                        setValidState(false);
                        return;
                    }

                    if (parsed.length === 0) {
                        showValidationStatus('info', 'JSON array is empty');
                        updateStats(0, 0, 0);
                        setValidState(false);
                        return;
                    }

                    if (parsed.length > 1000) {
                        showValidationStatus('invalid', `Too many objects (${parsed.length}). Maximum recommended is 1000.`);
                        updateStats(parsed.length, 0, parsed.length);
                        setValidState(false);
                        return;
                    }

                    // Validate each object
                    let validCount = 0;
                    let invalidCount = 0;
                    const errors = [];

                    parsed.forEach((obj, index) => {
                        if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
                            errors.push(`Object at index ${index}: Must be a plain object`);
                            invalidCount++;
                        } else {
                            validCount++;
                        }
                    });

                    if (errors.length > 0) {
                        const errorMessage = errors.slice(0, 5).join('; ') + 
                            (errors.length > 5 ? `; and ${errors.length - 5} more errors` : '');
                        showValidationStatus('invalid', errorMessage);
                        updateStats(parsed.length, validCount, invalidCount);
                        setValidState(false);
                    } else {
                        showValidationStatus('valid', `Valid JSON array with ${parsed.length} object(s)`);
                        updateStats(parsed.length, validCount, invalidCount);
                        setValidState(true);
                    }

                } catch (error) {
                    showValidationStatus('invalid', 'Invalid JSON format: ' + error.message);
                    updateStats(0, 0, 1);
                    setValidState(false);
                }
            }

            function showValidationStatus(type, message) {
                validationStatus.className = `validation-status ${type}`;
                validationStatus.textContent = message;
            }

            function updateStats(total, valid, invalid) {
                document.getElementById('objectCount').textContent = total;
                document.getElementById('validCount').textContent = valid;
                document.getElementById('invalidCount').textContent = invalid;
            }

            function setValidState(valid) {
                isJsonValid = valid;
                jsonTextarea.className = `json-textarea ${valid ? 'valid' : 'invalid'}`;
                insertButton.disabled = !valid;
                sidebarInsertButton.disabled = !valid;
            }

            function formatJson() {
                const jsonText = jsonTextarea.value.trim();
                if (!jsonText) return;

                try {
                    const parsed = JSON.parse(jsonText);
                    const formatted = JSON.stringify(parsed, null, 2);
                    jsonTextarea.value = formatted;
                } catch (error) {
                    // Don't format invalid JSON
                    return;
                }
            }

            function toggleExample() {
                const exampleJson = document.getElementById('exampleJson');
                if (exampleJson.style.display === 'none') {
                    exampleJson.style.display = 'block';
                } else {
                    exampleJson.style.display = 'none';
                }
            }

            // Make functions available globally
            window.toggleExample = toggleExample;
            window.formatJson = formatJson;

            // Initial validation
            validateJson();
        });
    </script>
</body>
</html>
